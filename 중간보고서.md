# 똑장 오프라인 파트 중간보고서

작성일: 2026-02-17  
범위: Sprint0 ~ Sprint2 + 시연용 UI 데모

## 1. 진행 개요
- 상세기획서 기준으로 Sprint0부터 Sprint2까지 백엔드 핵심 기능을 구현했습니다.
- 회의/시연을 위해 임시 프론트 데모(`backend/mock/ui-demo`)를 추가해 API 결과를 눈으로 확인할 수 있게 구성했습니다.
- 외부 Provider 장애 상황을 고려해 graceful degradation 및 fallback 동작까지 반영했습니다.

## 2. Sprint별 구현 내용
### Sprint0 (기초 구조/도메인)
- FastAPI 엔트리 및 라우팅 기본 구조 정리
- 오프라인 장보기 플랜 생성/선택 도메인 모델 정리
- Mock 기반 기본 플로우(입력 → 플랜 생성 → 선택) 확보

### Sprint1 (플랜 생성 엔진/정책)
- 품목 매칭(`product_norm`) 기반 장바구니 정규화 로직 구현
- 커버리지 필터(기준 0.6) + fallback(0.4) 정책 반영
- 랭킹 3종(`lowest`, `nearest`, `balanced`) 적용
- API 응답 코드/에러 스펙(200/206/400/422/503, select 404) 반영
- 금지 필드 미노출 규칙 준수

### Sprint2 (실연동/운영성 강화)
- Provider 연동
  - 네이버 장소 검색: `naver_place.py`
  - 네이버 길찾기: `naver_routing.py`
  - 기상청 단기예보: `kma_weather.py`
- 캐시/예산/복구
  - SQLite 캐시 서비스(`cache_service.py`) + TTL/패턴키 적용
  - Provider 호출 예산 추적(`provider_budget.py`)
  - Provider 장애 시 degraded 결과 반환 및 서비스 지속
- 앱 구성
  - `main.py`에서 실 Provider 주입
  - API 키 미설정 시 Mock fallback
  - cache DB lifecycle 관리

## 3. 추가 반영 사항 (회의 준비 과정)
### 3.1 사용자 위치 입력 UX 개선
- 좌표 직접 입력 대신 주소 입력 기반으로 변경
- `GET /v1/offline/utils/geocode` 유틸 API 추가
- Naver Local 검색 결과를 좌표로 변환해 기존 생성 API와 연결

### 3.2 품목 매칭 고도화
- 단순 하드코딩 매칭에서 유사도/토큰/alias 기반 점수화 매칭으로 확장
- 미매칭 품목 후보 Top-N 제공 API 추가:
  - `POST /v1/offline/utils/match-candidates`
- 데모 UI에서 사용자 선택으로 후보를 확정하는 흐름 구현

### 3.3 공공데이터(KAMIS) 동기화 파이프라인
- `scripts/sync_kamis_prices.py` 추가
- KAMIS 조회 데이터로 `product_norm`, `offline_price_snapshot` 업서트
- 환경변수:
  - `KAMIS_API_KEY`
  - `KAMIS_CERT_ID` (요청 인증 식별자)
- 검증/반영 결과:
  - 인증 성공 응답 확인
  - 적재 후 데이터 증가 확인 (`product_norm`, `offline_price_snapshot`)

## 4. 시연용 UI 데모 구현 현황
- 경로: `backend/mock/ui-demo/index.html`, `backend/mock/ui-demo/ui-demo.js`
- 기능:
  - 주소 입력 → geocode → generate 호출
  - 플랜 카드 목록/상세 확인
  - 미커버 품목/대체품 표시
  - 미매칭 품목 후보 선택(카드형 UI) 후 재요청
  - 최종 `select` 요청까지 연결
- 목적:
  - 기획서 16장(UI 화면 참조/API-UI 매핑) 기준의 시연 가능한 최소 제품(MVP Demo)

## 5. 테스트 및 품질 상태
- 자동 테스트: 전체 통과(최근 기준 39 passed)
- 핵심 회귀:
  - `test_api_routes.py`
  - `test_kamis_sync.py`
- 점검 반영:
  - `store_id` 생성 안정화(세션 의존 hash 이슈 개선)
  - `python-dotenv` 의존성 반영
  - 카테고리 추론 로직 동적화

## 6. 현재 리스크/주의사항
- Naver Directions 키 미발급 상태에서는 실제 경로거리 대신 fallback 동작 가능
- 지오코딩은 NCP Geocoding 미사용 시 Local 검색 정확도에 영향 가능
- KAMIS는 계정/인증정보 조합이 맞아야 실데이터 적재 가능

## 7. 내일 회의 공유용 요약
- Sprint0~2 핵심 요구사항은 백엔드 기준 구현 완료
- 외부 API 연동, 캐시, 예산제어, 장애 복구까지 포함해 운영 관점 대응
- 프론트는 시연 목적의 데모 버전 구현 완료(주소 입력/후보선택/플랜선택 전 과정)
- 다음 단계는 데모 UI를 정식 프론트로 이관하고, 실제 운영 키 기준 E2E 검증을 강화하는 것입니다.

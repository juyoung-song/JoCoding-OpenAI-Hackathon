# 똑장 ver2 클로즈드 베타 서비스화 계획 (2026-02-20 기준)

## 요약
- **현재 판단**: 지금 코드는 해커톤 데모 수준이며, 실사용자 대상 서비스 오픈 기준에는 **미달**입니다.
- **핵심 근거**:
  - 사용자 데이터 핵심 영역이 인메모리/기본 사용자 기반입니다: `똑장ver2/backend/src/api/v1/routers/basket.py:6`, `똑장ver2/backend/src/api/v1/routers/preferences.py:11`, `똑장ver2/backend/src/api/v1/routers/reservations.py:13`.
  - STT/위치/경로/날씨가 stub 중심입니다: `똑장ver2/backend/src/api/v1/routers/stt.py:1`, `똑장ver2/backend/src/infrastructure/providers/naver_local.py:1`, `똑장ver2/backend/src/infrastructure/providers/naver_routing.py:1`, `똑장ver2/backend/src/infrastructure/providers/kma_weather.py:1`.
  - 결제·로그인·약관/개인정보가 데모 placeholder입니다: `똑장ver2/frontend/src/pages/LoginScreen.tsx:14`, `똑장ver2/frontend/src/pages/PaymentMethodsScreen.tsx:27`, `똑장ver2/frontend/src/pages/TermsScreen.tsx:23`, `똑장ver2/frontend/src/pages/PrivacyPolicyScreen.tsx:23`.
  - 기획서 계약과 실제 API가 불일치합니다: 기획서 `최종 종합 기획서.md:470`, `최종 종합 기획서.md:484`, `최종 종합 기획서.md:493`, 실제 구현 `똑장ver2/backend/src/api/v1/routers/plans.py:112`.
  - 온라인 플랜 성능은 KPI 경계입니다: 로컬 실측(30회) `avg 3.89s / p95 4.16s / p99 5.03s / max 5.35s`로, KPI `5초(p99)` (`최종 종합 기획서.md:360`)를 간헐 초과합니다.
- **선택 확정 반영**: `클로즈드 베타`, `승인+결제샌드박스`, `JWT 로그인 + 서버저장`.

## 공용 API/인터페이스/타입 변경 (확정)
1. 인증 도입:
- 신규 `POST /api/v1/auth/login`, `POST /api/v1/auth/refresh`, `POST /api/v1/auth/logout`, `GET /api/v1/auth/me`.
- `basket/preferences/reservations/plans/chat`에서 `user_id` 쿼리 제거, `Bearer JWT`로 사용자 식별.
2. 플랜 API 정렬:
- 신규 `POST /api/v1/offline/plans/generate`, `POST /api/v1/offline/plans/select`, `POST /api/v1/online/plans/generate`, `POST /api/v1/online/plans/select`.
- 기존 `POST /api/v1/plans/generate`는 2주간 호환 어댑터로 유지 후 제거.
- 상태코드 표준화: `200/206/400/422/503`를 기획서 규칙과 일치시킴 (`최종 종합 기획서.md:474`, `최종 종합 기획서.md:488`).
3. URL 보안 계약 강제:
- 화이트리스트 실패 시 `400 INVALID_REDIRECT_URL` 반환 (현재 silent drop 제거).
4. 예약 계약 확장:
- `schedule_type`, `next_run_at`, `timezone`, `channel`, `last_run_at`, `last_result_status`, `retry_count` 추가.
- 스케줄러 디스패치/재시도/만료 정책 구현 (`최종 종합 기획서.md:339`, `최종 종합 기획서.md:397`, `최종 종합 기획서.md:398`).
5. 프론트 타입/상태 변경:
- `AppContext`의 주소/전화/주문이력/예약의 민감정보 localStorage 저장 제거, 서버 API SoR로 전환.
- `cart_url/mall_product_links` 실행 CTA 추가(온라인 실행 연결).

## 6주 실행 계획 (결정 완료)

### Phase 0 (D0~D2): 즉시 리스크 차단
- `.env`/`backend/.env` 평문 비밀키 전면 교체(rotate) 및 시크릿 매니저 이관.
- 로그 마스킹 필터 도입(API 키, 토큰, 전화번호, 주소 상세).
- 데모 문구를 “베타 준비중” 기준으로 통일하고, placeholder 화면에 기능 제한 안내 배너 추가.
- 완료 기준: 키 교체 완료, 비밀정보 평문 미노출, 보안 체크리스트 통과.

### Phase 1 (W1~W2): 계정/데이터 영속성 전환
- PostgreSQL + Alembic 도입, 사용자/장바구니/선호/예약/주문 테이블 생성.
- 인메모리 저장소 제거, Repository 계층으로 전환.
- JWT 인증/인가 적용, `user_default` 제거.
- 완료 기준: 서버 재시작 후 데이터 유지, 사용자 간 데이터 격리 테스트 통과.

### Phase 2 (W3): 계약 정합화 + 예약 실행엔진
- 플랜 API를 온라인/오프라인 분리 경로로 재구성.
- `select` API 구현 및 화이트리스트 실패 `400` 강제.
- 예약 스케줄러(1분 poll + 재시도 큐 + 만료 상태) 구현.
- 완료 기준: 기획서 API 계약 항목(경로/필드/상태코드) 100% 매핑 완료.

### Phase 3 (W4): 결제 샌드박스 + 승인 신뢰 UX
- 결제 샌드박스 연동(승인->결제 intent->확정) 추가.
- 승인 전 차단장치 2개 이상(예산 상한, 허용 판매처) UI/백엔드 검증 동시 적용.
- 온라인 실행 CTA(몰 이동/장바구니) 실제 동작 연결.
- 완료 기준: 입력→비교→승인→샌드박스 결제 흐름 3회 연속 성공.

### Phase 4 (W5): 성능/안정성 하드닝
- 온라인 검색 병렬화/중복제거/캐시 최적화.
- Provider timeout/retry/circuit breaker 적용.
- KPI 계측 추가(p95/p99, degraded 비율, 실패율).
- 완료 기준: 온라인 `p99 <= 5s`, degraded 시 UX 안내/상태코드 일치.

### Phase 5 (W6): 베타 런치 게이트
- 약관/개인정보처리방침 정식 문안 반영.
- 운영 대시보드/알람/온콜 런북 준비.
- 클로즈드 베타(20~50명) 단계적 오픈.
- 완료 기준: 보안/품질/법무/성능 게이트 전부 Green 후 베타 오픈.

## 실행 현황 업데이트 (2026-02-20 v1.1)
- ✅ **Phase 0 일부 완료**
  - `.env`, `backend/.env`의 평문 비밀키를 샘플 placeholder 형태로 정리
  - 로그 마스킹 필터(`src/core/logging_mask.py`) 도입
  - 로그인/약관/개인정보/결제수단 화면 문구를 “베타 준비중” 기준으로 정렬
- ✅ **Phase 1 핵심 완료 (SQLite 기반 선반영)**
  - 사용자/세션/장바구니/선호/예약/주문/프로필/플랜요청 테이블 추가
  - 인메모리 중심 라우터를 DB SoR + JWT 인증 기반으로 전환
  - `user_default` 쿼리 의존 제거
- ✅ **Phase 2 핵심 완료**
  - `POST /api/v1/offline/plans/generate|select`, `POST /api/v1/online/plans/generate|select` 구현
  - `POST /api/v1/plans/generate` 호환 어댑터 유지
  - degraded 응답 시 `206` 적용
  - 예약 확장 필드 + 1분 poll 스케줄러 디스패치 구현
  - 화이트리스트 미통과 redirect URL은 `400 INVALID_REDIRECT_URL`로 차단
- ✅ **프론트 타입/상태 계약 반영**
  - Bearer 토큰 기반 API 클라이언트 도입
  - 주소/전화/주문/예약의 localStorage SoR 제거, 서버 SoR로 전환
  - 온라인 실행 CTA(`cart_url/mall_product_links`) 연동
- ⚠️ **남은 항목**
  - PostgreSQL + Alembic 마이그레이션(현재는 SQLite 영속화 선반영)
  - 결제 샌드박스 실연동 및 승인-결제 intent 백엔드 계약
  - 성능 하드닝(online p99 안정화) 및 운영 게이트 자동화

## 실행 현황 업데이트 (2026-02-20 v1.2)
- ✅ **남은 4개 핵심 작업 반영 완료**
  - **PostgreSQL + Alembic 기반 추가**
    - `backend/alembic.ini`, `backend/alembic/env.py`, `backend/alembic/versions/20260220_0001_init_core_schema.py` 추가
    - `backend/src/infrastructure/persistence/schema.py`로 핵심 테이블 메타데이터 정리
    - `POSTGRES_DSN` 환경변수/가이드 추가
  - **결제 샌드박스 실연동 완료**
    - `POST /api/v1/payments/intents`, `GET /api/v1/payments/intents/{intent_id}`, `POST /api/v1/payments/intents/{intent_id}/confirm` 운영 라우터 연결
    - 프론트 `PaymentScreen`에서 `intent -> confirm -> 주문완료` 실흐름 연결
    - 예산 상한/허용 판매처 guardrail + idempotency 키 처리 반영
  - **온라인 성능/안정성 하드닝 반영**
    - 온라인 검색 병렬화(`OnlinePlanAdapter`)
    - Naver Shopping provider timeout/retry/circuit breaker/cache 적용
    - 온라인 KPI 수집기(`p95/p99/degraded/failure`) + Ops API 추가
  - **약관/개인정보/운영 게이트 자동화 반영**
    - Terms/Privacy 화면을 클로즈드 베타 정식 문안으로 교체
    - `scripts/run_beta_gate.ps1` 추가(`pytest`, `tsc`, `build` 자동 점검)
- ✅ **검증 결과**
  - `cd backend && pytest -q` -> `47 passed`
  - `cd frontend && npx tsc --noEmit` -> PASS
  - `cd frontend && npm run build` -> PASS
  - `cd backend && python -m compileall src alembic` -> PASS

## 실행 현황 업데이트 (2026-02-20 v1.3)
- ✅ **사용자 피드백 핫픽스 반영**
  - 챗봇 대화 시 `현재 AI 에이전트에 연결할 수 없어요` 문구가 반복 노출되던 문제 수정
  - OpenAI placeholder/권한 실패 상황에서도 규칙 기반 fallback으로 장바구니 조작 응답 지속
  - 예약 기능에 `last_run_at` 기반 인앱 알림(30초 폴링, 중복 방지 marker) 추가
- ✅ **검증 결과**
  - `cd backend && pytest -q` -> `48 passed`
  - `cd frontend && npx tsc --noEmit` -> PASS
  - `cd frontend && npm run build` -> PASS

## 실행 현황 업데이트 (2026-02-20 v1.4)
- ✅ **사용자 피드백 반영 (6개 이슈 대응)**
  - 챗봇: `깻잎/상추` 등 미등록 품목 입력 시에도 fallback 품목 추출로 장바구니 반영 가능하도록 수정
  - 결제 UX: 결제화면에서 배송지 관리 진입 후 저장 시 다시 결제 맥락으로 복귀되도록 수정
  - 채팅 기록 격리: 사용자 이메일 기반 저장키로 분리해 타 계정 채팅 기록 혼선 제거
  - 예약 승인대기 액션: 알림/예약목록에서 “장바구니 반영” 버튼으로 즉시 비교 흐름 연결
  - 다음 예약 표기: 생성순이 아닌 `next_run_at` 기준으로 가장 가까운 예약 우선 노출
  - 홈 알림 버튼: 알림센터 화면(`NOTIFICATIONS`) 연결 + 읽지 않은 알림 배지 반영
- ✅ **검증 결과**
  - `cd backend && pytest -q` -> `49 passed`
  - `cd frontend && npx tsc --noEmit` -> PASS
  - `cd frontend && npm run build` -> PASS

## 실행 현황 업데이트 (2026-02-20 v1.5)
- ✅ **하드코딩 완화 + 실연동 우선 배치 반영**
  - **LLM 실연동 강화**
    - `backend/src/core/llm.py` 신규: OpenAI 모델 fallback 체인(`OPENAI_FALLBACK_MODELS`) 기반 호출 유틸 추가
    - `backend/src/application/graph.py`:
      - analyzer를 모델 fallback 호출로 전환
      - LLM JSON 응답의 `entities`를 정규화해 장바구니 수정 파서와 병합
      - 모델 실패 시 규칙 기반 분기로 안전 fallback 유지
  - **공공데이터(KAMIS) 카탈로그 동기화 추가**
    - `backend/src/application/services/public_catalog_sync.py` 신규:
      - 카테고리별 KAMIS 데이터 수집/정규화
      - `product_norm`, `offline_price_snapshot` upsert 처리
    - `backend/src/api/v1/routers/public_data.py` 신규:
      - `POST /api/v1/public-data/catalog/sync`
      - `GET /api/v1/public-data/catalog/items`
    - `backend/src/main.py`:
      - 앱 기동 시 `PUBLIC_CATALOG_SYNC_ON_STARTUP=true`면 자동 동기화 시도
  - **환경/문서 반영**
    - `.env`, `backend/.env`: `OPENAI_FALLBACK_MODELS`, `PUBLIC_CATALOG_*` 추가
    - `backend/README.md`: 신규 공공데이터 API/환경변수 가이드 추가
- ✅ **검증 결과**
  - `cd backend && pytest -q` -> `51 passed`
  - `cd frontend && npx tsc --noEmit` -> PASS
  - `cd frontend && npm run build` -> PASS

## 실행 현황 업데이트 (2026-02-20 v1.6)
- ✅ **환경변수 복구 + 재기동 반영**
  - `.env_backup`를 기준으로 `.env`, `backend/.env`의 실키 값 병합 복원
  - 기존 파일은 `*.before_restore_YYYYMMDD_HHMMSS` 스냅샷으로 백업 생성
  - 백엔드/프론트 서버 프로세스 재기동 완료
- ✅ **보안 보강 (로그 민감정보)**
  - `backend/src/core/logging_mask.py`:
    - `p_cert_key`, `p_cert_id`, `api_key`, `client_secret`, `access_token` 쿼리/JSON 마스킹 패턴 추가
  - `backend/src/main.py`:
    - `httpx/httpcore` 로그 레벨을 `WARNING`으로 하향해 요청 URL 노출 억제
  - 기존 로그 파일(`backend_server.log`, `backend_server.err.log`) 초기화
- ✅ **실행 확인**
  - `GET http://localhost:8000/health` -> `200`
  - `GET http://localhost:5173` -> `200`

## 실행 현황 업데이트 (2026-02-20 v1.7)
- ✅ **프롬프트/코드 의존성 분리 반영**
  - `backend/src/application/prompts/` 폴더 신설
  - `backend/src/application/prompts/analyzer.system.txt`:
    - 기존 `graph.py` 내 analyzer system prompt를 파일 템플릿으로 이동
    - `{preferences}`, `{basket_status}` 변수 placeholder 유지
  - `backend/src/application/prompts/loader.py` 신규:
    - 프롬프트 템플릿 파일 로드(`load_prompt_template`)
    - 변수 렌더링(`render_prompt`) 및 누락 변수 검증
    - 경로 traversal 방지
  - `backend/src/application/graph.py`:
    - 하드코딩 `ANALYZER_PROMPT` 제거
    - `render_prompt("analyzer.system.txt", ...)` 방식으로 교체
- ✅ **테스트/검증**
  - `backend/tests/test_prompt_loader.py` 신규 (템플릿 로드/렌더/누락변수 검증)
  - `cd backend && pytest -q` -> `54 passed`
  - `GET http://localhost:8000/health` -> `200` (재기동 후 확인)

## 테스트 케이스/시나리오 (필수)
1. 인증/권한: 무토큰 접근 차단, 토큰 만료/재발급, 사용자 데이터 격리.
2. 계약 테스트: 온라인/오프라인 generate/select의 상태코드와 스키마 검증.
3. 보안 테스트: 화이트리스트 외 URL 400, PII 마스킹, 로그 민감정보 무노출.
4. 예약 테스트: `next_run_at` 도래→재계산 작업 생성→승인 대기→만료/재알림.
5. 결제 테스트: 샌드박스 승인 실패/성공/중복 요청 idempotency.
6. 프론트 E2E: 입력→비교→승인→결제→이력, 온라인/오프라인 각각 3회.
7. 성능 테스트: 5품목/동시사용자 시나리오로 `p95/p99` 측정, 외부 API 장애 주입.
8. 회귀 게이트: `pytest -q`, `npx tsc --noEmit`, `npm run build`, Playwright smoke.

## 가정 및 기본값
- 릴리스 목표는 **클로즈드 베타(4~6주)**로 고정.
- 결제는 **샌드박스**만, 실결제는 베타 후속 단계.
- 인증은 **JWT + 서버 저장** 고정, 익명/로컬 전용 모드는 제거.
- 베타 동안 자동결제는 금지하고 승인 기반 실행만 유지.
- 성능 기준은 기획서 기준(`p99 5초`, 3스텝)으로 통일.

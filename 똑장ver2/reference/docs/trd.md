# 똑장(똑똑한 장보기) TRD v2.0

> **개발 시 반드시 이 문서를 참고해야 합니다.**
> 레퍼런스 코드(`reference/backend/`) 기반으로 작성된 실전 기술 명세입니다.

 **문서 버전** : v2.0
 **작성일** : 2026-02-18
 **레퍼런스** : `reference/backend/reference_guide.md`, `reference/guide2.md`

---

## 1. 기술 스택

| 레이어                  | Dev                       | Production            |
| ----------------------- | ------------------------- | --------------------- |
| **Frontend**      | React PWA                 | React PWA             |
| **Backend**       | FastAPI + LangGraph       | FastAPI + LangGraph   |
| **LLM**           | GPT-4o-mini (OpenAI)      | GPT-4o-mini           |
| **DB**            | SQLite (aiosqlite)        | PostgreSQL            |
| **캐시**          | SQLite 기반 CacheService  | Redis                 |
| **STT**           | Whisper (서버)            | Whisper               |
| **온라인 가격**   | 네이버쇼핑 API            | 네이버쇼핑 API        |
| **오프라인 매장** | MockOfflineProvider       | 네이버 Local API      |
| **이동시간**      | 직선거리 근사 (Haversine) | 네이버 Directions API |
| **날씨**          | MockWeatherProvider       | 기상청 단기예보 API   |
| **관측**          | Langfuse (선택)           | Langfuse              |

### 개발 원칙

* **OpenAPI 계약 먼저** → 프론트/백 병렬 개발
* **Provider 패턴** : 모든 외부 데이터 소스는 ABC 인터페이스로 격리
* **API 키 유무 자동 선택** : `lifespan`에서 키 존재 시 실제 Provider, 없으면 Mock 자동 선택
* **SQLite 캐시 우선** : Dev 환경에서 Redis 없이 SQLite CacheService로 캐시 구현
* **스크래핑 금지** : 약관/차단/유지보수 리스크

---

## 2. 프로젝트 디렉토리 구조

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60"></div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">backend/</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1">├── src/</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">│   ├── main.py                          # FastAPI 앱 엔트리포인트 (lifespan)</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">│   ├── config.py                        # Settings (frozen dataclass / pydantic-settings)</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">│   ├── domain/</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">│   │   ├── models/</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">│   │   │   ├── basket.py                # BasketItem, Basket, ItemMode</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1">│   │   │   ├── plan.py                  # Plan, PlanItem, PlanType</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1">│   │   │   ├── preferences.py           # PreferredBrand</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1">│   │   │   └── user_preferences.py      # ShoppingContext, Location, TransportMode</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1">│   │   └── types.py                     # 공통 도메인 타입 (Pydantic)</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1">│   ├── application/</span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk1">│   │   ├── services/</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk1">│   │   │   ├── chat_service.py          # LLM 챗봇 서비스</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk1">│   │   │   ├── canonicalization.py      # 품목명 표준화 (Canonical ID)</span></div></div><div class="code-line" data-line-number="16" data-line-start="16" data-line-end="16"><div class="line-content"><span class="mtk1">│   │   │   └── mall_comparer.py         # 몰별 최저가 비교</span></div></div><div class="code-line" data-line-number="17" data-line-start="17" data-line-end="17"><div class="line-content"><span class="mtk1">│   │   └── usecases/</span></div></div><div class="code-line" data-line-number="18" data-line-start="18" data-line-end="18"><div class="line-content"><span class="mtk1">│   │       └── generate_plans.py        # 플랜 생성 유즈케이스</span></div></div><div class="code-line" data-line-number="19" data-line-start="19" data-line-end="19"><div class="line-content"><span class="mtk1">│   ├── infrastructure/</span></div></div><div class="code-line" data-line-number="20" data-line-start="20" data-line-end="20"><div class="line-content"><span class="mtk1">│   │   ├── persistence/</span></div></div><div class="code-line" data-line-number="21" data-line-start="21" data-line-end="21"><div class="line-content"><span class="mtk1">│   │   │   ├── database.py              # DB 초기화, WAL 모드</span></div></div><div class="code-line" data-line-number="22" data-line-start="22" data-line-end="22"><div class="line-content"><span class="mtk1">│   │   │   ├── cache_service.py         # SQLite 기반 TTL 캐시</span></div></div><div class="code-line" data-line-number="23" data-line-start="23" data-line-end="23"><div class="line-content"><span class="mtk1">│   │   │   └── repositories/</span></div></div><div class="code-line" data-line-number="24" data-line-start="24" data-line-end="24"><div class="line-content"><span class="mtk1">│   │   │       ├── preference_repository.py</span></div></div><div class="code-line" data-line-number="25" data-line-start="25" data-line-end="25"><div class="line-content"><span class="mtk1">│   │   │       └── shopping_settings_repository.py</span></div></div><div class="code-line" data-line-number="26" data-line-start="26" data-line-end="26"><div class="line-content"><span class="mtk1">│   │   ├── providers/</span></div></div><div class="code-line" data-line-number="27" data-line-start="27" data-line-end="27"><div class="line-content"><span class="mtk1">│   │   │   ├── base.py                  # ABC Provider 인터페이스</span></div></div><div class="code-line" data-line-number="28" data-line-start="28" data-line-end="28"><div class="line-content"><span class="mtk1">│   │   │   ├── naver_shopping.py        # 네이버쇼핑 Hybrid Search</span></div></div><div class="code-line" data-line-number="29" data-line-start="29" data-line-end="29"><div class="line-content"><span class="mtk1">│   │   │   ├── naver_local.py           # 네이버 Local 매장 검색</span></div></div><div class="code-line" data-line-number="30" data-line-start="30" data-line-end="30"><div class="line-content"><span class="mtk1">│   │   │   ├── naver_routing.py         # 네이버 Directions 이동시간</span></div></div><div class="code-line" data-line-number="31" data-line-start="31" data-line-end="31"><div class="line-content"><span class="mtk1">│   │   │   ├── kma_weather.py           # 기상청 날씨</span></div></div><div class="code-line" data-line-number="32" data-line-start="32" data-line-end="32"><div class="line-content"><span class="mtk1">│   │   │   ├── mock_offline.py          # MVP Mock 오프라인</span></div></div><div class="code-line" data-line-number="33" data-line-start="33" data-line-end="33"><div class="line-content"><span class="mtk1">│   │   │   └── provider_budget.py       # API 예산 관리</span></div></div><div class="code-line" data-line-number="34" data-line-start="34" data-line-end="34"><div class="line-content"><span class="mtk1">│   │   └── graph/</span></div></div><div class="code-line" data-line-number="35" data-line-start="35" data-line-end="35"><div class="line-content"><span class="mtk1">│   │       ├── state/chat_state.py      # LangGraph 상태</span></div></div><div class="code-line" data-line-number="36" data-line-start="36" data-line-end="36"><div class="line-content"><span class="mtk1">│   │       ├── graph_builder.py         # 그래프 빌더</span></div></div><div class="code-line" data-line-number="37" data-line-start="37" data-line-end="37"><div class="line-content"><span class="mtk1">│   │       └── nodes/</span></div></div><div class="code-line" data-line-number="38" data-line-start="38" data-line-end="38"><div class="line-content"><span class="mtk1">│   │           ├── parse.py             # 파싱 노드</span></div></div><div class="code-line" data-line-number="39" data-line-start="39" data-line-end="39"><div class="line-content"><span class="mtk1">│   │           └── clarify.py           # 명확화 노드</span></div></div><div class="code-line" data-line-number="40" data-line-start="40" data-line-end="40"><div class="line-content"><span class="mtk1">│   └── api/</span></div></div><div class="code-line" data-line-number="41" data-line-start="41" data-line-end="41"><div class="line-content"><span class="mtk1">│       └── v1/routers/</span></div></div><div class="code-line" data-line-number="42" data-line-start="42" data-line-end="42"><div class="line-content"><span class="mtk1">│           ├── basket.py                # 장바구니 CRUD</span></div></div><div class="code-line" data-line-number="43" data-line-start="43" data-line-end="43"><div class="line-content"><span class="mtk1">│           ├── chat.py                  # 챗봇 API</span></div></div><div class="code-line" data-line-number="44" data-line-start="44" data-line-end="44"><div class="line-content"><span class="mtk1">│           ├── plans.py                 # 플랜 생성/조회</span></div></div><div class="code-line" data-line-number="45" data-line-start="45" data-line-end="45"><div class="line-content"><span class="mtk1">│           ├── preferences.py           # 선호 브랜드</span></div></div><div class="code-line" data-line-number="46" data-line-start="46" data-line-end="46"><div class="line-content"><span class="mtk1">│           └── stt.py                   # 음성 인식</span></div></div></div></div></div></div></pre>

---

## 3. 설정 관리 (config.py)

레퍼런스 기반 `frozen=True` dataclass 또는 pydantic-settings 방식 사용.

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk8"># pydantic-settings 방식 (권장)</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk3">from</span><span class="mtk1"> pydantic_settings </span><span class="mtk3">import</span><span class="mtk1"> BaseSettings</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">Settings</span><span class="mtk1">(</span><span class="mtk6">BaseSettings</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">    app_name: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">"똑장"</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">    debug: </span><span class="mtk16">bool</span><span class="mtk1"> = </span><span class="mtk5">True</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">    api_prefix: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">"/api/v1"</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># DB</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1">    db_path: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">"app.db"</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1">    cache_db_path: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">"cache.db"</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># LLM</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk1">    openai_api_key: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">""</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk1">    openai_model: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">"gpt-4o-mini"</span></div></div><div class="code-line" data-line-number="16" data-line-start="16" data-line-end="16"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="17" data-line-start="17" data-line-end="17"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># 네이버 API (쇼핑 + Local)</span></div></div><div class="code-line" data-line-number="18" data-line-start="18" data-line-end="18"><div class="line-content"><span class="mtk1">    naver_client_id: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">""</span></div></div><div class="code-line" data-line-number="19" data-line-start="19" data-line-end="19"><div class="line-content"><span class="mtk1">    naver_client_secret: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">""</span></div></div><div class="code-line" data-line-number="20" data-line-start="20" data-line-end="20"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="21" data-line-start="21" data-line-end="21"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># 네이버 클라우드 (Directions)</span></div></div><div class="code-line" data-line-number="22" data-line-start="22" data-line-end="22"><div class="line-content"><span class="mtk1">    ncp_client_id: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">""</span></div></div><div class="code-line" data-line-number="23" data-line-start="23" data-line-end="23"><div class="line-content"><span class="mtk1">    ncp_client_secret: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">""</span></div></div><div class="code-line" data-line-number="24" data-line-start="24" data-line-end="24"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="25" data-line-start="25" data-line-end="25"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># 기상청</span></div></div><div class="code-line" data-line-number="26" data-line-start="26" data-line-end="26"><div class="line-content"><span class="mtk1">    kma_service_key: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">""</span></div></div><div class="code-line" data-line-number="27" data-line-start="27" data-line-end="27"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="28" data-line-start="28" data-line-end="28"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># 캐시 TTL (초)</span></div></div><div class="code-line" data-line-number="29" data-line-start="29" data-line-end="29"><div class="line-content"><span class="mtk1">    cache_ttl_place: </span><span class="mtk16">int</span><span class="mtk1"> = </span><span class="mtk5">1800</span><span class="mtk1"></span><span class="mtk8"># 30분</span></div></div><div class="code-line" data-line-number="30" data-line-start="30" data-line-end="30"><div class="line-content"><span class="mtk1">    cache_ttl_route_car: </span><span class="mtk16">int</span><span class="mtk1"> = </span><span class="mtk5">600</span><span class="mtk1"></span><span class="mtk8"># 10분</span></div></div><div class="code-line" data-line-number="31" data-line-start="31" data-line-end="31"><div class="line-content"><span class="mtk1">    cache_ttl_weather: </span><span class="mtk16">int</span><span class="mtk1"> = </span><span class="mtk5">1800</span><span class="mtk1"></span><span class="mtk8"># 30분</span></div></div><div class="code-line" data-line-number="32" data-line-start="32" data-line-end="32"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="33" data-line-start="33" data-line-end="33"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># API 예산</span></div></div><div class="code-line" data-line-number="34" data-line-start="34" data-line-end="34"><div class="line-content"><span class="mtk1">    monthly_api_call_limit: </span><span class="mtk16">int</span><span class="mtk1"> = </span><span class="mtk5">300_000</span></div></div><div class="code-line" data-line-number="35" data-line-start="35" data-line-end="35"><div class="line-content"><span class="mtk1">    budget_warning_ratio: </span><span class="mtk16">float</span><span class="mtk1"> = </span><span class="mtk5">0.80</span></div></div><div class="code-line" data-line-number="36" data-line-start="36" data-line-end="36"><div class="line-content"><span class="mtk1">    budget_critical_ratio: </span><span class="mtk16">float</span><span class="mtk1"> = </span><span class="mtk5">0.95</span></div></div><div class="code-line" data-line-number="37" data-line-start="37" data-line-end="37"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="38" data-line-start="38" data-line-end="38"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># Langfuse (선택)</span></div></div><div class="code-line" data-line-number="39" data-line-start="39" data-line-end="39"><div class="line-content"><span class="mtk1">    langfuse_secret_key: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">""</span></div></div><div class="code-line" data-line-number="40" data-line-start="40" data-line-end="40"><div class="line-content"><span class="mtk1">    langfuse_public_key: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">""</span></div></div><div class="code-line" data-line-number="41" data-line-start="41" data-line-end="41"><div class="line-content"><span class="mtk1">    langfuse_base_url: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">"https://cloud.langfuse.com"</span></div></div><div class="code-line" data-line-number="42" data-line-start="42" data-line-end="42"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="43" data-line-start="43" data-line-end="43"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># CORS</span></div></div><div class="code-line" data-line-number="44" data-line-start="44" data-line-end="44"><div class="line-content"><span class="mtk1">    cors_origins: list[</span><span class="mtk16">str</span><span class="mtk1">] = [</span><span class="mtk6">"http://localhost:5173"</span><span class="mtk1">]</span></div></div><div class="code-line" data-line-number="45" data-line-start="45" data-line-end="45"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="46" data-line-start="46" data-line-end="46"><div class="line-content"><span class="mtk1">    model_config = {</span><span class="mtk6">"env_file"</span><span class="mtk1">: </span><span class="mtk6">".env"</span><span class="mtk1">, </span><span class="mtk6">"env_file_encoding"</span><span class="mtk1">: </span><span class="mtk6">"utf-8"</span><span class="mtk1">}</span></div></div><div class="code-line" data-line-number="47" data-line-start="47" data-line-end="47"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="48" data-line-start="48" data-line-end="48"><div class="line-content"><span class="mtk1">settings = </span><span class="mtk13">Settings</span><span class="mtk1">()</span></div></div></div></div></div></div></pre>

### 환경변수 파일 (.env)

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">env</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">OPENAI_API_KEY=</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1">NAVER_CLIENT_ID=</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">NAVER_CLIENT_SECRET=</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">NCP_CLIENT_ID=</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">NCP_CLIENT_SECRET=</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">KMA_SERVICE_KEY=</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">LANGFUSE_SECRET_KEY=</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1">LANGFUSE_PUBLIC_KEY=</span></div></div></div></div></div></div></pre>

---

## 4. 데이터베이스 설계

### 4.1 앱 DB 스키마 (SQLite → PostgreSQL)

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">sql</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk8">-- 오프라인 매장 마스터</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk3">CREATE</span><span class="mtk1"></span><span class="mtk3">TABLE</span><span class="mtk1"></span><span class="mtk13">store_master</span><span class="mtk1"> (</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">    store_id   </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">PRIMARY KEY</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">    store_name </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span><span class="mtk3">address</span><span class="mtk1"></span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">    category   </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">    lat        </span><span class="mtk3">REAL</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1">    lng        </span><span class="mtk3">REAL</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1">    source     </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1">    is_active  </span><span class="mtk3">INTEGER</span><span class="mtk1"></span><span class="mtk3">DEFAULT</span><span class="mtk1"></span><span class="mtk5">1</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1">    updated_at </span><span class="mtk3">DATETIME</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1">);</span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk8">-- 상품 표준화 테이블</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk3">CREATE</span><span class="mtk1"></span><span class="mtk3">TABLE</span><span class="mtk1"></span><span class="mtk13">product_norm</span><span class="mtk1"> (</span></div></div><div class="code-line" data-line-number="16" data-line-start="16" data-line-end="16"><div class="line-content"><span class="mtk1">    product_norm_key </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">PRIMARY KEY</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="17" data-line-start="17" data-line-end="17"><div class="line-content"><span class="mtk1">    normalized_name  </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="18" data-line-start="18" data-line-end="18"><div class="line-content"><span class="mtk1">    brand            </span><span class="mtk3">TEXT</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="19" data-line-start="19" data-line-end="19"><div class="line-content"><span class="mtk1">    size_value       </span><span class="mtk3">REAL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="20" data-line-start="20" data-line-end="20"><div class="line-content"><span class="mtk1">    size_unit        </span><span class="mtk3">TEXT</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="21" data-line-start="21" data-line-end="21"><div class="line-content"><span class="mtk1">    size_display     </span><span class="mtk3">TEXT</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="22" data-line-start="22" data-line-end="22"><div class="line-content"><span class="mtk1">    category         </span><span class="mtk3">TEXT</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="23" data-line-start="23" data-line-end="23"><div class="line-content"><span class="mtk1">    aliases_json     </span><span class="mtk3">TEXT</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="24" data-line-start="24" data-line-end="24"><div class="line-content"><span class="mtk1">    updated_at       </span><span class="mtk3">DATETIME</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span></div></div><div class="code-line" data-line-number="25" data-line-start="25" data-line-end="25"><div class="line-content"><span class="mtk1">);</span></div></div><div class="code-line" data-line-number="26" data-line-start="26" data-line-end="26"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="27" data-line-start="27" data-line-end="27"><div class="line-content"><span class="mtk8">-- 오프라인 가격 스냅샷</span></div></div><div class="code-line" data-line-number="28" data-line-start="28" data-line-end="28"><div class="line-content"><span class="mtk3">CREATE</span><span class="mtk1"></span><span class="mtk3">TABLE</span><span class="mtk1"></span><span class="mtk13">offline_price_snapshot</span><span class="mtk1"> (</span></div></div><div class="code-line" data-line-number="29" data-line-start="29" data-line-end="29"><div class="line-content"><span class="mtk1">    price_snapshot_key </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">PRIMARY KEY</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="30" data-line-start="30" data-line-end="30"><div class="line-content"><span class="mtk1">    store_id           </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1"></span><span class="mtk3">REFERENCES</span><span class="mtk1"> store_master(store_id),</span></div></div><div class="code-line" data-line-number="31" data-line-start="31" data-line-end="31"><div class="line-content"><span class="mtk1">    product_norm_key   </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1"></span><span class="mtk3">REFERENCES</span><span class="mtk1"> product_norm(product_norm_key),</span></div></div><div class="code-line" data-line-number="32" data-line-start="32" data-line-end="32"><div class="line-content"><span class="mtk1">    price_won          </span><span class="mtk3">INTEGER</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1"></span><span class="mtk3">CHECK</span><span class="mtk1">(price_won </span><span class="mtk16">></span><span class="mtk1"></span><span class="mtk5">0</span><span class="mtk1">),</span></div></div><div class="code-line" data-line-number="33" data-line-start="33" data-line-end="33"><div class="line-content"><span class="mtk1">    observed_at        </span><span class="mtk3">DATETIME</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="34" data-line-start="34" data-line-end="34"><div class="line-content"><span class="mtk1">    source             </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="35" data-line-start="35" data-line-end="35"><div class="line-content"><span class="mtk1">    notice             </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,  </span><span class="mtk8">-- "조사 시점 기준, 현장 가격과 차이 가능"</span></div></div><div class="code-line" data-line-number="36" data-line-start="36" data-line-end="36"><div class="line-content"><span class="mtk1">    created_at         </span><span class="mtk3">DATETIME</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span></div></div><div class="code-line" data-line-number="37" data-line-start="37" data-line-end="37"><div class="line-content"><span class="mtk1">);</span></div></div><div class="code-line" data-line-number="38" data-line-start="38" data-line-end="38"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="39" data-line-start="39" data-line-end="39"><div class="line-content"><span class="mtk8">-- 운영 로그 (최소 운영용)</span></div></div><div class="code-line" data-line-number="40" data-line-start="40" data-line-end="40"><div class="line-content"><span class="mtk3">CREATE</span><span class="mtk1"></span><span class="mtk3">TABLE</span><span class="mtk1"></span><span class="mtk13">offline_plan_execution_log</span><span class="mtk1"> (</span></div></div><div class="code-line" data-line-number="41" data-line-start="41" data-line-end="41"><div class="line-content"><span class="mtk1">    execution_id          </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">PRIMARY KEY</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="42" data-line-start="42" data-line-end="42"><div class="line-content"><span class="mtk1">    request_id            </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="43" data-line-start="43" data-line-end="43"><div class="line-content"><span class="mtk1">    item_count            </span><span class="mtk3">INTEGER</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="44" data-line-start="44" data-line-end="44"><div class="line-content"><span class="mtk1">    candidate_store_count </span><span class="mtk3">INTEGER</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="45" data-line-start="45" data-line-end="45"><div class="line-content"><span class="mtk1">    filtered_store_count  </span><span class="mtk3">INTEGER</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="46" data-line-start="46" data-line-end="46"><div class="line-content"><span class="mtk1">    selected_plan_types   </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="47" data-line-start="47" data-line-end="47"><div class="line-content"><span class="mtk1">    latency_ms            </span><span class="mtk3">INTEGER</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="48" data-line-start="48" data-line-end="48"><div class="line-content"><span class="mtk1">    degraded              </span><span class="mtk3">INTEGER</span><span class="mtk1"></span><span class="mtk3">DEFAULT</span><span class="mtk1"></span><span class="mtk5">0</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="49" data-line-start="49" data-line-end="49"><div class="line-content"><span class="mtk1">    created_at            </span><span class="mtk3">DATETIME</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span></div></div><div class="code-line" data-line-number="50" data-line-start="50" data-line-end="50"><div class="line-content"><span class="mtk1">);</span></div></div><div class="code-line" data-line-number="51" data-line-start="51" data-line-end="51"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="52" data-line-start="52" data-line-end="52"><div class="line-content"><span class="mtk3">CREATE</span><span class="mtk1"></span><span class="mtk3">TABLE</span><span class="mtk1"></span><span class="mtk13">offline_provider_call_log</span><span class="mtk1"> (</span></div></div><div class="code-line" data-line-number="53" data-line-start="53" data-line-end="53"><div class="line-content"><span class="mtk1">    call_id       </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">PRIMARY KEY</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="54" data-line-start="54" data-line-end="54"><div class="line-content"><span class="mtk1">    provider_name </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="55" data-line-start="55" data-line-end="55"><div class="line-content"><span class="mtk1">    endpoint_key  </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="56" data-line-start="56" data-line-end="56"><div class="line-content"><span class="mtk1">    status_code   </span><span class="mtk3">INTEGER</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="57" data-line-start="57" data-line-end="57"><div class="line-content"><span class="mtk1">    latency_ms    </span><span class="mtk3">INTEGER</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="58" data-line-start="58" data-line-end="58"><div class="line-content"><span class="mtk1">    cache_hit     </span><span class="mtk3">INTEGER</span><span class="mtk1"></span><span class="mtk3">DEFAULT</span><span class="mtk1"></span><span class="mtk5">0</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="59" data-line-start="59" data-line-end="59"><div class="line-content"><span class="mtk1">    error_class   </span><span class="mtk3">TEXT</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="60" data-line-start="60" data-line-end="60"><div class="line-content"><span class="mtk1">    created_at    </span><span class="mtk3">DATETIME</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span></div></div><div class="code-line" data-line-number="61" data-line-start="61" data-line-end="61"><div class="line-content"><span class="mtk1">);</span></div></div><div class="code-line" data-line-number="62" data-line-start="62" data-line-end="62"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="63" data-line-start="63" data-line-end="63"><div class="line-content"><span class="mtk3">CREATE</span><span class="mtk1"></span><span class="mtk3">TABLE</span><span class="mtk1"></span><span class="mtk13">offline_plan_selection_log</span><span class="mtk1"> (</span></div></div><div class="code-line" data-line-number="64" data-line-start="64" data-line-end="64"><div class="line-content"><span class="mtk1">    selection_id       </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">PRIMARY KEY</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="65" data-line-start="65" data-line-end="65"><div class="line-content"><span class="mtk1">    request_id         </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="66" data-line-start="66" data-line-end="66"><div class="line-content"><span class="mtk1">    selected_plan_type </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="67" data-line-start="67" data-line-end="67"><div class="line-content"><span class="mtk1">    store_id           </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="68" data-line-start="68" data-line-end="68"><div class="line-content"><span class="mtk1">    selected_at        </span><span class="mtk3">DATETIME</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span></div></div><div class="code-line" data-line-number="69" data-line-start="69" data-line-end="69"><div class="line-content"><span class="mtk1">);</span></div></div></div></div></div></div></pre>

### 4.2 캐시 DB 스키마

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">sql</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk3">CREATE</span><span class="mtk1"></span><span class="mtk3">TABLE</span><span class="mtk1"></span><span class="mtk13">cache_entries</span><span class="mtk1"> (</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1">    cache_key  </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">PRIMARY KEY</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">    value_json </span><span class="mtk3">TEXT</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">    expires_at </span><span class="mtk3">DATETIME</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">    created_at </span><span class="mtk3">DATETIME</span><span class="mtk1"></span><span class="mtk3">NOT NULL</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">);</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk3">CREATE</span><span class="mtk1"></span><span class="mtk3">INDEX</span><span class="mtk1"></span><span class="mtk13">idx_cache_expires</span><span class="mtk1"></span><span class="mtk3">ON</span><span class="mtk1"> cache_entries(expires_at);</span></div></div></div></div></div></div></pre>

### 4.3 DB 초기화 패턴

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk8"># WAL 모드 + foreign keys 필수</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">get_app_db</span><span class="mtk1">() -> aiosqlite.Connection:</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">    db = </span><span class="mtk3">await</span><span class="mtk1"> aiosqlite.</span><span class="mtk13">connect</span><span class="mtk1">(</span><span class="mtk5">_APP_DB_PATH</span><span class="mtk1">)</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">    db.row_factory = aiosqlite.Row  </span><span class="mtk8"># ← 반드시 설정</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span><span class="mtk3">await</span><span class="mtk1"> db.</span><span class="mtk13">execute</span><span class="mtk1">(</span><span class="mtk6">"PRAGMA journal_mode=WAL"</span><span class="mtk1">)</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1"></span><span class="mtk3">await</span><span class="mtk1"> db.</span><span class="mtk13">execute</span><span class="mtk1">(</span><span class="mtk6">"PRAGMA foreign_keys=ON"</span><span class="mtk1">)</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1"></span><span class="mtk3">return</span><span class="mtk1"> db</span></div></div></div></div></div></div></pre>

> ⚠️ `db.row_factory = aiosqlite.Row` 없으면 `dict(row)` 변환 불가

---

## 5. 도메인 모델

### 5.1 BasketItem / Basket

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">ItemMode</span><span class="mtk1">(</span><span class="mtk16">str</span><span class="mtk1">, </span><span class="mtk6">Enum</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk5">FIXED</span><span class="mtk1"> = </span><span class="mtk6">"fixed"</span><span class="mtk1"></span><span class="mtk8"># 🔒 브랜드 고정 — 자동 변경 금지</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk5">RECOMMEND</span><span class="mtk1"> = </span><span class="mtk6">"recommend"</span><span class="mtk1"></span><span class="mtk8"># ⭐ 추천모드 — AI가 최적 브랜드 선택</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">BasketItem</span><span class="mtk1">(</span><span class="mtk6">BaseModel</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">    item_name: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk8"># 정규화된 품목명</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">    brand: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk16">|</span><span class="mtk1"></span><span class="mtk5">None</span><span class="mtk1"></span><span class="mtk8"># 브랜드 (없으면 추천모드에서 결정)</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1">    size: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk16">|</span><span class="mtk1"></span><span class="mtk5">None</span><span class="mtk1"></span><span class="mtk8"># 용량/규격 (예: 30구, 1L)</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1">    quantity: </span><span class="mtk16">int</span><span class="mtk1"> = </span><span class="mtk5">1</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1">    category: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk16">|</span><span class="mtk1"></span><span class="mtk5">None</span><span class="mtk1"></span><span class="mtk8"># 카테고리 (예: 축산/계란)</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1">    mode: ItemMode = ItemMode.</span><span class="mtk5">RECOMMEND</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1">    canonical_id: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk16">|</span><span class="mtk1"></span><span class="mtk5">None</span><span class="mtk1"></span><span class="mtk8"># 표준 품목 ID (예: EGG_30)</span></div></div></div></div></div></div></pre>

### 5.2 Plan / PlanItem

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">PlanType</span><span class="mtk1">(</span><span class="mtk16">str</span><span class="mtk1">, </span><span class="mtk6">Enum</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk5">CHEAPEST</span><span class="mtk1"> = </span><span class="mtk6">"cheapest"</span><span class="mtk1"></span><span class="mtk8"># A: 최저가</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk5">NEAREST</span><span class="mtk1">  = </span><span class="mtk6">"nearest"</span><span class="mtk1"></span><span class="mtk8"># B: 가까움</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk5">BALANCED</span><span class="mtk1"> = </span><span class="mtk6">"balanced"</span><span class="mtk1"></span><span class="mtk8"># C: 균형</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">Plan</span><span class="mtk1">(</span><span class="mtk6">BaseModel</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">    plan_type: PlanType</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1">    mart_name: </span><span class="mtk16">str</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1">    mart_icon: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk16">|</span><span class="mtk1"></span><span class="mtk5">None</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1">    items: list[PlanItem]</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1">    estimated_total: </span><span class="mtk16">int</span><span class="mtk1"></span><span class="mtk8"># 추정 총액 (원)</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1">    coverage: </span><span class="mtk16">int</span><span class="mtk1"></span><span class="mtk8"># 커버된 품목 수</span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk1">    total_basket_items: </span><span class="mtk16">int</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk1">    delivery_info: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk16">|</span><span class="mtk1"></span><span class="mtk5">None</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk1">    badges: list[</span><span class="mtk16">str</span><span class="mtk1">]</span></div></div><div class="code-line" data-line-number="16" data-line-start="16" data-line-end="16"><div class="line-content"><span class="mtk1">    explanation: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk8"># 추천 이유 (AI 생성)</span></div></div><div class="code-line" data-line-number="17" data-line-start="17" data-line-end="17"><div class="line-content"><span class="mtk1">    cart_url: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk16">|</span><span class="mtk1"></span><span class="mtk5">None</span><span class="mtk1"></span><span class="mtk8"># 딥링크 URL</span></div></div><div class="code-line" data-line-number="18" data-line-start="18" data-line-end="18"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="19" data-line-start="19" data-line-end="19"><div class="line-content"><span class="mtk13">    @</span><span class="mtk16">property</span></div></div><div class="code-line" data-line-number="20" data-line-start="20" data-line-end="20"><div class="line-content"><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">coverage_ratio</span><span class="mtk1">(</span><span class="mtk7 mtki">self</span><span class="mtk1">) -> </span><span class="mtk16">float</span><span class="mtk1">:</span></div></div><div class="code-line" data-line-number="21" data-line-start="21" data-line-end="21"><div class="line-content"><span class="mtk1"></span><span class="mtk3">if</span><span class="mtk1"></span><span class="mtk4">self</span><span class="mtk1">.total_basket_items </span><span class="mtk16">==</span><span class="mtk1"></span><span class="mtk5">0</span><span class="mtk1">:</span></div></div><div class="code-line" data-line-number="22" data-line-start="22" data-line-end="22"><div class="line-content"><span class="mtk1"></span><span class="mtk3">return</span><span class="mtk1"></span><span class="mtk5">0.0</span></div></div><div class="code-line" data-line-number="23" data-line-start="23" data-line-end="23"><div class="line-content"><span class="mtk1"></span><span class="mtk3">return</span><span class="mtk1"></span><span class="mtk4">self</span><span class="mtk1">.coverage </span><span class="mtk16">/</span><span class="mtk1"></span><span class="mtk4">self</span><span class="mtk1">.total_basket_items</span></div></div></div></div></div></div></pre>

### 5.3 ShoppingContext (사용자 설정)

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">ShoppingContext</span><span class="mtk1">(</span><span class="mtk6">BaseModel</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1">    location: Location       </span><span class="mtk8"># 위도/경도 + 주소</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">    mobility: </span><span class="mtk16">dict</span><span class="mtk1"></span><span class="mtk8"># {"mode": "walk", "max_minutes": 30}</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">    online_malls: </span><span class="mtk16">dict</span><span class="mtk1"></span><span class="mtk8"># {"naver": True, "coupang": True, "kurly": False}</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">    updated_at: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk16">|</span><span class="mtk1"></span><span class="mtk5">None</span></div></div></div></div></div></div></pre>

---

## 6. Provider 인터페이스 (ABC)

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">OnlinePriceProvider</span><span class="mtk1">(</span><span class="mtk5">ABC</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk13">    @abstractmethod</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">search_products</span><span class="mtk1">(</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">item</span><span class="mtk1">: BasketItem, </span><span class="mtk5 mtki">max_results</span><span class="mtk1">: </span><span class="mtk16">int</span><span class="mtk1"> = </span><span class="mtk5">5</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">    ) -> list[PlanItem]: </span><span class="mtk5">...</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">OfflinePriceProvider</span><span class="mtk1">(</span><span class="mtk5">ABC</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk13">    @abstractmethod</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1"></span><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">get_store_prices</span><span class="mtk1">(</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1"></span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">item</span><span class="mtk1">: BasketItem, </span><span class="mtk5 mtki">lat</span><span class="mtk1">: </span><span class="mtk16">float</span><span class="mtk1">, </span><span class="mtk5 mtki">lng</span><span class="mtk1">: </span><span class="mtk16">float</span><span class="mtk1">, </span><span class="mtk5 mtki">radius_km</span><span class="mtk1">: </span><span class="mtk16">float</span><span class="mtk1"> = </span><span class="mtk5">3.0</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1">    ) -> list[PlanItem]: </span><span class="mtk5">...</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">STTProvider</span><span class="mtk1">(</span><span class="mtk5">ABC</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk13">    @abstractmethod</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk1"></span><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">transcribe</span><span class="mtk1">(</span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">audio_bytes</span><span class="mtk1">: </span><span class="mtk16">bytes</span><span class="mtk1">) -> </span><span class="mtk16">str</span><span class="mtk1">: </span><span class="mtk5">...</span></div></div><div class="code-line" data-line-number="16" data-line-start="16" data-line-end="16"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="17" data-line-start="17" data-line-end="17"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">PlaceProvider</span><span class="mtk1">(</span><span class="mtk5">ABC</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="18" data-line-start="18" data-line-end="18"><div class="line-content"><span class="mtk13">    @abstractmethod</span></div></div><div class="code-line" data-line-number="19" data-line-start="19" data-line-end="19"><div class="line-content"><span class="mtk1"></span><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">search_nearby_stores</span><span class="mtk1">(</span></div></div><div class="code-line" data-line-number="20" data-line-start="20" data-line-end="20"><div class="line-content"><span class="mtk1"></span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">lat</span><span class="mtk1">: </span><span class="mtk16">float</span><span class="mtk1">, </span><span class="mtk5 mtki">lng</span><span class="mtk1">: </span><span class="mtk16">float</span><span class="mtk1">, </span><span class="mtk5 mtki">keyword</span><span class="mtk1">: </span><span class="mtk16">str</span><span class="mtk1"> = </span><span class="mtk6">"마트"</span><span class="mtk1">, </span><span class="mtk5 mtki">radius_km</span><span class="mtk1">: </span><span class="mtk16">float</span><span class="mtk1"> = </span><span class="mtk5">3.0</span></div></div><div class="code-line" data-line-number="21" data-line-start="21" data-line-end="21"><div class="line-content"><span class="mtk1">    ) -> list[</span><span class="mtk16">dict</span><span class="mtk1">]: </span><span class="mtk5">...</span></div></div><div class="code-line" data-line-number="22" data-line-start="22" data-line-end="22"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="23" data-line-start="23" data-line-end="23"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">WeatherProvider</span><span class="mtk1">(</span><span class="mtk5">ABC</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="24" data-line-start="24" data-line-end="24"><div class="line-content"><span class="mtk13">    @abstractmethod</span></div></div><div class="code-line" data-line-number="25" data-line-start="25" data-line-end="25"><div class="line-content"><span class="mtk1"></span><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">get_current_weather</span><span class="mtk1">(</span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">lat</span><span class="mtk1">: </span><span class="mtk16">float</span><span class="mtk1">, </span><span class="mtk5 mtki">lng</span><span class="mtk1">: </span><span class="mtk16">float</span><span class="mtk1">) -> </span><span class="mtk16">dict</span><span class="mtk1">: </span><span class="mtk5">...</span></div></div></div></div></div></div></pre>

---

## 7. 네이버쇼핑 Provider — Hybrid Search Strategy

레퍼런스의 핵심 패턴. **Phase1 광범위 검색 + Phase2 누락 몰 타겟 검색** 2단계 전략.

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60"></div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">Phase 1: 일반 검색 (최저가 정렬, display=80)</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1">  → 결과에서 TARGET_MALLS 필터링</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">  → 식품 카테고리 판별 (_is_food_item)</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">Phase 2: 누락 몰 타겟 검색 (display=40, sort=sim)</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">  → Phase1에서 없는 몰만 대상</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">  → "{query} {몰이름}" 으로 재검색</span></div></div></div></div></div></div></pre>

### 핵심 상수

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk8"># 검색어 품질 향상</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk5">QUERY_OVERRIDES</span><span class="mtk1"> = {</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"계란"</span><span class="mtk1">: </span><span class="mtk6">"달걀 특란 30개입"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"달걀"</span><span class="mtk1">: </span><span class="mtk6">"달걀 특란 30개입"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">}</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk8"># 규격 정규화</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk5">SIZE_NORMALIZATION</span><span class="mtk1"> = {</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"30구"</span><span class="mtk1">: </span><span class="mtk6">"30개입"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"15구"</span><span class="mtk1">: </span><span class="mtk6">"15개입"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1">}</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk8"># 대형마트/주요 몰 화이트리스트</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk5">TARGET_MALLS</span><span class="mtk1"> = {</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"이마트"</span><span class="mtk1">, </span><span class="mtk6">"이마트몰"</span><span class="mtk1">, </span><span class="mtk6">"트레이더스"</span><span class="mtk1">, </span><span class="mtk6">"SSG"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="16" data-line-start="16" data-line-end="16"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"홈플러스"</span><span class="mtk1">, </span><span class="mtk6">"롯데마트"</span><span class="mtk1">, </span><span class="mtk6">"쿠팡"</span><span class="mtk1">, </span><span class="mtk6">"마켓컬리"</span><span class="mtk1">, </span><span class="mtk6">"농협몰"</span><span class="mtk1">, </span><span class="mtk6">"GS프레시몰"</span></div></div><div class="code-line" data-line-number="17" data-line-start="17" data-line-end="17"><div class="line-content"><span class="mtk1">}</span></div></div><div class="code-line" data-line-number="18" data-line-start="18" data-line-end="18"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="19" data-line-start="19" data-line-end="19"><div class="line-content"><span class="mtk8"># 몰별 장바구니 딥링크</span></div></div><div class="code-line" data-line-number="20" data-line-start="20" data-line-end="20"><div class="line-content"><span class="mtk5">CART_LINKS</span><span class="mtk1"> = {</span></div></div><div class="code-line" data-line-number="21" data-line-start="21" data-line-end="21"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"emart"</span><span class="mtk1">:   </span><span class="mtk6">"https://m.ssg.com/cart/dcart.ssg"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="22" data-line-start="22" data-line-end="22"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"homeplus"</span><span class="mtk1">:</span><span class="mtk6">"https://front.homeplus.co.kr/cart"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="23" data-line-start="23" data-line-end="23"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"kurly"</span><span class="mtk1">:   </span><span class="mtk6">"https://www.kurly.com/cart"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="24" data-line-start="24" data-line-end="24"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"coupang"</span><span class="mtk1">: </span><span class="mtk6">"https://mc.coupang.com/"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="25" data-line-start="25" data-line-end="25"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"lotte"</span><span class="mtk1">:   </span><span class="mtk6">"https://www.lotteon.com/display/ec/m/cart/cartList"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="26" data-line-start="26" data-line-end="26"><div class="line-content"><span class="mtk1">}</span></div></div><div class="code-line" data-line-number="27" data-line-start="27" data-line-end="27"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="28" data-line-start="28" data-line-end="28"><div class="line-content"><span class="mtk8"># 몰 별칭 정규화</span></div></div><div class="code-line" data-line-number="29" data-line-start="29" data-line-end="29"><div class="line-content"><span class="mtk5">MALL_ALIASES</span><span class="mtk1"> = {</span></div></div><div class="code-line" data-line-number="30" data-line-start="30" data-line-end="30"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"emart"</span><span class="mtk1">:    [</span><span class="mtk6">"이마트"</span><span class="mtk1">, </span><span class="mtk6">"이마트몰"</span><span class="mtk1">, </span><span class="mtk6">"SSG"</span><span class="mtk1">, </span><span class="mtk6">"SSG.COM"</span><span class="mtk1">, </span><span class="mtk6">"신세계몰"</span><span class="mtk1">, </span><span class="mtk6">"트레이더스"</span><span class="mtk1">],</span></div></div><div class="code-line" data-line-number="31" data-line-start="31" data-line-end="31"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"homeplus"</span><span class="mtk1">: [</span><span class="mtk6">"홈플러스"</span><span class="mtk1">, </span><span class="mtk6">"Homeplus"</span><span class="mtk1">],</span></div></div><div class="code-line" data-line-number="32" data-line-start="32" data-line-end="32"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"kurly"</span><span class="mtk1">:    [</span><span class="mtk6">"컬리"</span><span class="mtk1">, </span><span class="mtk6">"마켓컬리"</span><span class="mtk1">, </span><span class="mtk6">"Kurly"</span><span class="mtk1">],</span></div></div><div class="code-line" data-line-number="33" data-line-start="33" data-line-end="33"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"coupang"</span><span class="mtk1">:  [</span><span class="mtk6">"쿠팡"</span><span class="mtk1">, </span><span class="mtk6">"Coupang"</span><span class="mtk1">],</span></div></div><div class="code-line" data-line-number="34" data-line-start="34" data-line-end="34"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"lotte"</span><span class="mtk1">:    [</span><span class="mtk6">"롯데마트"</span><span class="mtk1">, </span><span class="mtk6">"롯데ON"</span><span class="mtk1">],</span></div></div><div class="code-line" data-line-number="35" data-line-start="35" data-line-end="35"><div class="line-content"><span class="mtk1">}</span></div></div></div></div></div></div></pre>

### 검색 쿼리 빌드 규칙

| 모드                                  | 쿼리                             |
| ------------------------------------- | -------------------------------- |
| FIXED (🔒)                            | `"{brand} {item_name} {size}"` |
| RECOMMEND (⭐) + QUERY_OVERRIDES 있음 | override 사용                    |
| RECOMMEND (⭐) + 없음                 | `"{item_name} {size}"`         |

---

## 8. 오프라인 Provider

### 8.1 MVP: MockOfflineProvider

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk5">MOCK_STORE_PRICES</span><span class="mtk1"> = {</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"이마트"</span><span class="mtk1">:   {</span><span class="mtk6">"계란"</span><span class="mtk1">: </span><span class="mtk5">7480</span><span class="mtk1">, </span><span class="mtk6">"우유"</span><span class="mtk1">: </span><span class="mtk5">2980</span><span class="mtk1">, </span><span class="mtk6">"두부"</span><span class="mtk1">: </span><span class="mtk5">3200</span><span class="mtk1">, </span><span class="mtk5">...</span><span class="mtk1">},</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"홈플러스"</span><span class="mtk1">: {</span><span class="mtk6">"계란"</span><span class="mtk1">: </span><span class="mtk5">7200</span><span class="mtk1">, </span><span class="mtk6">"우유"</span><span class="mtk1">: </span><span class="mtk5">3100</span><span class="mtk1">, </span><span class="mtk6">"두부"</span><span class="mtk1">: </span><span class="mtk5">2900</span><span class="mtk1">, </span><span class="mtk5">...</span><span class="mtk1">},</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"롯데마트"</span><span class="mtk1">: {</span><span class="mtk6">"계란"</span><span class="mtk1">: </span><span class="mtk5">7600</span><span class="mtk1">, </span><span class="mtk6">"우유"</span><span class="mtk1">: </span><span class="mtk5">2850</span><span class="mtk1">, </span><span class="mtk6">"두부"</span><span class="mtk1">: </span><span class="mtk5">3100</span><span class="mtk1">, </span><span class="mtk5">...</span><span class="mtk1">},</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">}</span></div></div></div></div></div></div></pre>

### 8.2 Sprint 2: 네이버 Local Provider

> ⚠️  **주의** : 네이버 Local API는 좌표 필터링 미지원. `lat/lng` 파라미터가 실제로 사용되지 않음.
> 카카오 Local API로 교체 검토 필요.

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk5">MART_KEYWORDS</span><span class="mtk1"> = [</span><span class="mtk6">"이마트"</span><span class="mtk1">, </span><span class="mtk6">"홈플러스"</span><span class="mtk1">, </span><span class="mtk6">"롯데마트"</span><span class="mtk1">, </span><span class="mtk6">"코스트코"</span><span class="mtk1">, </span><span class="mtk6">"하나로마트"</span><span class="mtk1">, </span><span class="mtk6">"GS더프레시"</span><span class="mtk1">]</span></div></div></div></div></div></div></pre>

* 키워드별 검색 후 Haversine 거리 필터링
* 캐시 키: `place:{lat:.3f}:{lng:.3f}:{category}:{radius}`
* TTL: 30분

### 8.3 이동시간 계산

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk8"># 직선거리 근사 (MVP Fallback)</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">_estimate_linear</span><span class="mtk1">(</span><span class="mtk5 mtki">origin</span><span class="mtk1">, </span><span class="mtk5 mtki">destination</span><span class="mtk1">, </span><span class="mtk5 mtki">travel_mode</span><span class="mtk1">) -> RouteEstimate:</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># Haversine 공식으로 직선거리 계산</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk3">if</span><span class="mtk1"> travel_mode </span><span class="mtk16">==</span><span class="mtk1"></span><span class="mtk6">"walk"</span><span class="mtk1">:</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">        minutes = </span><span class="mtk16">round</span><span class="mtk1">(distance_km </span><span class="mtk16">*</span><span class="mtk1"></span><span class="mtk5">1000</span><span class="mtk1"></span><span class="mtk16">*</span><span class="mtk1"></span><span class="mtk5">1.3</span><span class="mtk1"></span><span class="mtk16">/</span><span class="mtk1"></span><span class="mtk5">66.7</span><span class="mtk1">)   </span><span class="mtk8"># 4km/h, 경로계수 1.3</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1"></span><span class="mtk3">elif</span><span class="mtk1"> travel_mode </span><span class="mtk16">==</span><span class="mtk1"></span><span class="mtk6">"transit"</span><span class="mtk1">:</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">        minutes = </span><span class="mtk16">round</span><span class="mtk1">(distance_km </span><span class="mtk16">*</span><span class="mtk1"></span><span class="mtk5">1000</span><span class="mtk1"></span><span class="mtk16">*</span><span class="mtk1"></span><span class="mtk5">1.8</span><span class="mtk1"></span><span class="mtk16">/</span><span class="mtk1"></span><span class="mtk5">66.7</span><span class="mtk1">)</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1"></span><span class="mtk3">else</span><span class="mtk1">:  </span><span class="mtk8"># car</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1">        minutes = </span><span class="mtk16">max</span><span class="mtk1">(</span><span class="mtk5">1</span><span class="mtk1">, </span><span class="mtk16">round</span><span class="mtk1">(distance_km </span><span class="mtk16">/</span><span class="mtk1"></span><span class="mtk5">0.5</span><span class="mtk1">))           </span><span class="mtk8"># 30km/h 도심</span></div></div></div></div></div></div></pre>

> Sprint 2: 차량 → 네이버 Directions API, 대중교통 → ODsay API

### 8.4 날씨 Provider (기상청)

> ⚠️ `_to_grid()` — 위경도 → 기상청 격자(nx, ny) 변환 LCC DFS 공식 **절대 수정 금지**

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk8"># 기상청 발표 시각 자동 계산 (10분 여유 포함)</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk5">BASE_TIMES</span><span class="mtk1"> = [</span><span class="mtk6">"0200"</span><span class="mtk1">, </span><span class="mtk6">"0500"</span><span class="mtk1">, </span><span class="mtk6">"0800"</span><span class="mtk1">, </span><span class="mtk6">"1100"</span><span class="mtk1">, </span><span class="mtk6">"1400"</span><span class="mtk1">, </span><span class="mtk6">"1700"</span><span class="mtk1">, </span><span class="mtk6">"2000"</span><span class="mtk1">, </span><span class="mtk6">"2300"</span><span class="mtk1">]</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk8"># 날씨 안내 생성 기준</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk8"># PTY > 0 → "비 예보" / "눈 예보"</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk8"># POP >= 60 → "강수확률 N%"</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk8"># SKY: 1=맑음, 3=구름많음, 4=흐림</span></div></div></div></div></div></div></pre>

---

## 9. API 예산 관리

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">BudgetExceededError</span><span class="mtk1">(RuntimeError):</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"""월간 API 호출 예산 초과."""</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">enforce_api_budget</span><span class="mtk1">(</span><span class="mtk5 mtki">db</span><span class="mtk1">, </span><span class="mtk5 mtki">settings</span><span class="mtk1">) -> tuple[</span><span class="mtk16">int</span><span class="mtk1">, </span><span class="mtk16">bool</span><span class="mtk1">]:</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"""</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk6">    월간 호출량 확인 → critical 임계치 초과 시 BudgetExceededError 발생</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk6">    Returns: (used_calls, is_warning)</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk6">    """</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># monthly_api_call_limit의 80% → 경고</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># 95% → 차단 (BudgetExceededError)</span></div></div></div></div></div></div></pre>

모든 Provider에서 API 호출 전 `await enforce_api_budget(db, settings)` 호출 필수.

---

## 10. SQLite 캐시 서비스

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">CacheService</span><span class="mtk1">:</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">get</span><span class="mtk1">(</span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">key</span><span class="mtk1">: </span><span class="mtk16">str</span><span class="mtk1">) -> Optional[</span><span class="mtk16">str</span><span class="mtk1">]: </span><span class="mtk5">...</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk16">set</span><span class="mtk1">(</span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">key</span><span class="mtk1">: </span><span class="mtk16">str</span><span class="mtk1">, </span><span class="mtk5 mtki">value_json</span><span class="mtk1">: </span><span class="mtk16">str</span><span class="mtk1">, </span><span class="mtk5 mtki">ttl_seconds</span><span class="mtk1">: </span><span class="mtk16">int</span><span class="mtk1">): </span><span class="mtk5">...</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">delete_pattern</span><span class="mtk1">(</span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">prefix</span><span class="mtk1">: </span><span class="mtk16">str</span><span class="mtk1">) -> </span><span class="mtk16">int</span><span class="mtk1">: </span><span class="mtk5">...</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">cleanup_expired</span><span class="mtk1">(</span><span class="mtk7 mtki">self</span><span class="mtk1">) -> </span><span class="mtk16">int</span><span class="mtk1">: </span><span class="mtk5">...</span></div></div></div></div></div></div></pre>

### 캐시 키 규칙

| 데이터           | 캐시 키                                                 | TTL  |
| ---------------- | ------------------------------------------------------- | ---- |
| 네이버 장소 검색 | `place:{lat:.3f}:{lng:.3f}:{category}:{radius}`       | 30분 |
| 차량 이동시간    | `route:car:{lat:.5f}:{lng:.5f}:{dlat:.5f}:{dlng:.5f}` | 10분 |
| 날씨             | `weather:{lat:.2f}:{lng:.2f}:{yyyymmddhh}`            | 30분 |

> 장소 `:.3f`, 경로 `:.5f` — 정밀도 다름 (의도적)

---

## 11. 품목명 표준화 (Canonicalization)

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">CanonicalizationService</span><span class="mtk1">:</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk5">KEYWORD_MAP</span><span class="mtk1"> = {</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"계란"</span><span class="mtk1">: </span><span class="mtk6">"EGG"</span><span class="mtk1">, </span><span class="mtk6">"달걀"</span><span class="mtk1">: </span><span class="mtk6">"EGG"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"두부"</span><span class="mtk1">: </span><span class="mtk6">"TOFU"</span><span class="mtk1">, </span><span class="mtk6">"우유"</span><span class="mtk1">: </span><span class="mtk6">"MILK"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"신라면"</span><span class="mtk1">: </span><span class="mtk6">"SHIN_RAMYUN"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"파"</span><span class="mtk1">: </span><span class="mtk6">"GREEN_ONION"</span><span class="mtk1">, </span><span class="mtk6">"대파"</span><span class="mtk1">: </span><span class="mtk6">"GREEN_ONION"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1"></span><span class="mtk5">...</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1">    }</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">get_canonical_id</span><span class="mtk1">(</span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">item_name</span><span class="mtk1">: </span><span class="mtk16">str</span><span class="mtk1">, </span><span class="mtk5 mtki">size</span><span class="mtk1">: </span><span class="mtk16">str</span><span class="mtk1"></span><span class="mtk16">|</span><span class="mtk1"></span><span class="mtk5">None</span><span class="mtk1">) -> </span><span class="mtk16">str</span><span class="mtk1">:</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># "계란", "30구" → "EGG_30"</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># "두부", "300g" → "TOFU_300"</span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># 계란 기본값: "EGG_30"</span></div></div></div></div></div></div></pre>

선호 브랜드 DB 매칭의 핵심 키로 사용됨.

---

## 12. 랭킹 엔진 (RankingEngine)

3종 플랜 정책으로 Top3 선정.

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk3">class</span><span class="mtk1"></span><span class="mtk14">RankingEngine</span><span class="mtk1">:</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk5">MIN_COVERAGE</span><span class="mtk1"> = </span><span class="mtk5">0.6</span><span class="mtk1"></span><span class="mtk8"># 기본 커버리지 필터</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk5">FALLBACK_MIN_COVERAGE</span><span class="mtk1"> = </span><span class="mtk5">0.4</span><span class="mtk1"></span><span class="mtk8"># 후보 부족 시 허용</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># 정렬 정책</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># CHEAPEST:  total_price ASC → coverage DESC → travel_minutes ASC</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># NEAREST:   travel_minutes ASC → total_price ASC → coverage DESC</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># BALANCED:  0.5*norm_price + 0.3*norm_travel - 0.2*norm_coverage (낮을수록 좋음)</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">_compute_balanced_scores</span><span class="mtk1">(</span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">candidates</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"""min-max 정규화 후 가중합."""</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># price_range = max - min (or 1)</span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># norm_price = (price - min) / price_range</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># balanced_score = 0.5*norm_price + 0.3*norm_travel - 0.2*norm_coverage</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="16" data-line-start="16" data-line-end="16"><div class="line-content"><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">_deduplicate</span><span class="mtk1">(</span><span class="mtk7 mtki">self</span><span class="mtk1">, </span><span class="mtk5 mtki">result</span><span class="mtk1">, </span><span class="mtk5 mtki">candidates</span><span class="mtk1">):</span></div></div><div class="code-line" data-line-number="17" data-line-start="17" data-line-end="17"><div class="line-content"><span class="mtk1"></span><span class="mtk6">"""BALANCED가 CHEAPEST/NEAREST와 같은 매장이면 차선책으로 교체."""</span></div></div></div></div></div></div></pre>

---

## 13. AI 챗 서비스 (ChatService)

GPT-4o-mini 기반 장바구니 비서. 장바구니 컨텍스트를 시스템 프롬프트에 주입.

### 13.1 시스템 프롬프트 구조

### 4.2 ChatService (AI 장보기 비서)

* **모델** : GPT-4o-mini
* **역할** : 자연어 대화 → 장바구니 변경안(`diff`) 생성
* **Context Injection (선호도 주입)** :
* LLM 호출 **전**에 사용자 선호 브랜드(User Preferences)를 System Prompt에 주입.
* 예: "사용자는 '우유'에 대해 '서울우유'를 선호함" → LLM이 이를 인지하고 "서울우유로 담아드릴까요?"라고 대화 가능.
* **Diff 포맷** :

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">json</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">{</span><span class="mtk3">"diff"</span><span class="mtk1">: [{</span><span class="mtk3">"action"</span><span class="mtk1">: </span><span class="mtk6">"add"</span><span class="mtk1">, </span><span class="mtk3">"item_name"</span><span class="mtk1">: </span><span class="mtk6">"계란"</span><span class="mtk1">, </span><span class="mtk3">"brand"</span><span class="mtk1">: </span><span class="mtk6">"풀무원"</span><span class="mtk1">, </span><span class="mtk3">"quantity"</span><span class="mtk1">: </span><span class="mtk5">1</span><span class="mtk1">}]}</span></div></div></div></div></div></div></pre>

* **프로세스** :

1. 사용자 메시지 수신
2. `PreferenceRepo`에서 선호도 조회
3. System Prompt 구성 (장바구니 상태 +  **선호도 정보** )
4. LLM 호출 → 응답 및 Diff 파싱
5. 클라이언트에 응답 반환

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60"></div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">- `action`: `add` / `remove` / `modify`</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1">- `mode`: `recommend`(⭐) / `fixed`(🔒)</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">### 13.3 선호 브랜드 자동 적용 (_apply_preferences)</span></div></div></div></div></div></div></pre>

diff 항목 → Canonical ID 조회 → 선호 브랜드 DB 확인 → 선호 브랜드 있으면 자동 적용 + mode="fixed" → 규격 불일치 시 수량 자동 보정 (예: 60구 → 30구 x2)

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60"></div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">### 13.4 대화 히스토리</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">- MVP: 인메모리 (`_chat_history`, 최대 20개)</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">- 서버 재시작 시 초기화 → DB 연동 시 해결</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">---</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1">## 14. LangGraph 에이전트 설계</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1">### 14.1 ChatState (공유 상태)</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1">```python</span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk1">class ChatState(TypedDict):</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk1">    messages: Annotated[list, add_messages]  # 대화 히스토리</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk1">    basket_items: list[BasketItem]           # 현재 장바구니</span></div></div><div class="code-line" data-line-number="16" data-line-start="16" data-line-end="16"><div class="line-content"><span class="mtk1">    pending_diff: list[dict] | None          # 사용자 확인 대기 변경안</span></div></div><div class="code-line" data-line-number="17" data-line-start="17" data-line-end="17"><div class="line-content"><span class="mtk1">    intent: str | None                       # add/remove/recipe/search/general</span></div></div></div></div></div></div></pre>

### 14.2 그래프 흐름

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60"></div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">[START]</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1">    │</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">    ▼</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">[parse_node]</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">  - 사용자 입력 → intent 판별</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">  - intent: add/remove/modify/recipe/search/clear/general</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">  - pending_diff 생성 (사용자 확인 전)</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1">    │</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1">    ▼</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1">[clarify_node]</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1">  - 불확실한 품목 명확화 요청</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1">  - 선호 브랜드 자동 적용</span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk1">    │</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk1">    ▼</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk1">[END]</span></div></div></div></div></div></div></pre>

### 14.3 Parse 노드 프롬프트 (의도 분류)

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60"></div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">intent 분류:</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1">- add: 장바구니에 품목 추가</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">- remove: 장바구니에서 품목 삭제</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">- modify: 기존 품목 수정 (수량, 브랜드 등)</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">- recipe: 요리 기반 재료 자동 구성</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">- search: 가격 비교 / 분석 시작 요청</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">- clear: 전체 삭제</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1">- general: 일반 대화</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1">규칙: 변경안(diff)을 먼저 보여주고, 사용자 확인 후에만 적용</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1">규칙: 고정모드(🔒) 브랜드 자동 변경 금지</span></div></div></div></div></div></div></pre>

---

## 15. API 명세

### 15.1 공통 규칙

* Base URL: `/api/v1`
* 인증: Bearer Token (JWT)
* 에러 응답:

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">json</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">{</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"code"</span><span class="mtk1">: </span><span class="mtk6">"BASKET_NOT_FOUND"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"message"</span><span class="mtk1">: </span><span class="mtk6">"장바구니를 찾을 수 없습니다."</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"details"</span><span class="mtk1">: [],</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"request_id"</span><span class="mtk1">: </span><span class="mtk6">"uuid"</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">}</span></div></div></div></div></div></div></pre>

### 15.2 장바구니 API

| Method     | Path                    | 설명               |
| ---------- | ----------------------- | ------------------ |
| `GET`    | `/basket`             | 현재 장바구니 조회 |
| `POST`   | `/basket`             | 품목 추가          |
| `DELETE` | `/basket/{item_name}` | 품목 삭제          |
| `DELETE` | `/basket`             | 전체 비우기        |

**POST /basket Request**

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">json</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">{</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"item_name"</span><span class="mtk1">: </span><span class="mtk6">"계란"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"brand"</span><span class="mtk1">: </span><span class="mtk5">null</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"size"</span><span class="mtk1">: </span><span class="mtk6">"30구"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"quantity"</span><span class="mtk1">: </span><span class="mtk5">1</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"category"</span><span class="mtk1">: </span><span class="mtk6">"축산/계란"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"mode"</span><span class="mtk1">: </span><span class="mtk6">"recommend"</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1">}</span></div></div></div></div></div></div></pre>

### 15.3 플랜 API

| Method   | Path                        | 설명                    |
| -------- | --------------------------- | ----------------------- |
| `POST` | `/plans/generate`         | Top3 플랜 생성          |
| `GET`  | `/plans`                  | 마지막 플랜 조회 (캐시) |
| `POST` | `/plans/{plan_id}/select` | 플랜 선택 기록          |

**POST /plans/generate Response**

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">json</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">{</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"top3"</span><span class="mtk1">: [</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">    {</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"plan_type"</span><span class="mtk1">: </span><span class="mtk6">"cheapest"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"mart_name"</span><span class="mtk1">: </span><span class="mtk6">"이마트몰 (SSG)"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"mart_icon"</span><span class="mtk1">: </span><span class="mtk6">"🏪"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"estimated_total"</span><span class="mtk1">: </span><span class="mtk5">42800</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"coverage"</span><span class="mtk1">: </span><span class="mtk5">10</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"total_basket_items"</span><span class="mtk1">: </span><span class="mtk5">10</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"coverage_ratio"</span><span class="mtk1">: </span><span class="mtk5">1.0</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"explanation"</span><span class="mtk1">: </span><span class="mtk6">"이마트몰에서 10개 품목 모두 구매 가능. 예상 총액 42,800원."</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"cart_url"</span><span class="mtk1">: </span><span class="mtk6">"https://m.ssg.com/cart/dcart.ssg"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"badges"</span><span class="mtk1">: [</span><span class="mtk6">"이마트몰 최저가"</span><span class="mtk1">],</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"items"</span><span class="mtk1">: [</span><span class="mtk25">...</span><span class="mtk1">]</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk1">    }</span></div></div><div class="code-line" data-line-number="16" data-line-start="16" data-line-end="16"><div class="line-content"><span class="mtk1">  ],</span></div></div><div class="code-line" data-line-number="17" data-line-start="17" data-line-end="17"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"alternatives"</span><span class="mtk1">: [],</span></div></div><div class="code-line" data-line-number="18" data-line-start="18" data-line-end="18"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"headline"</span><span class="mtk1">: </span><span class="mtk6">"이마트몰에서 42,800원이 최저가에요"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="19" data-line-start="19" data-line-end="19"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"last_updated"</span><span class="mtk1">: </span><span class="mtk6">"오늘 17:37 기준"</span></div></div><div class="code-line" data-line-number="20" data-line-start="20" data-line-end="20"><div class="line-content"><span class="mtk1">}</span></div></div></div></div></div></div></pre>

### 15.4 챗봇 API

| Method   | Path               | 설명            |
| -------- | ------------------ | --------------- |
| `POST` | `/chat/message`  | 메시지 전송     |
| `GET`  | `/chat/greeting` | 첫 인사말       |
| `POST` | `/chat/clear`    | 히스토리 초기화 |

**POST /chat/message Response**

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">json</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">{</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"role"</span><span class="mtk1">: </span><span class="mtk6">"assistant"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"content"</span><span class="mtk1">: </span><span class="mtk6">"계란 30구를 추가할까요?"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"diff"</span><span class="mtk1">: [</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">    {</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"action"</span><span class="mtk1">: </span><span class="mtk6">"add"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"item"</span><span class="mtk1">: {</span><span class="mtk3">"item_name"</span><span class="mtk1">: </span><span class="mtk6">"계란"</span><span class="mtk1">, </span><span class="mtk3">"size"</span><span class="mtk1">: </span><span class="mtk6">"30구"</span><span class="mtk1">, </span><span class="mtk3">"quantity"</span><span class="mtk1">: </span><span class="mtk5">1</span><span class="mtk1">, </span><span class="mtk3">"mode"</span><span class="mtk1">: </span><span class="mtk6">"recommend"</span><span class="mtk1">},</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"reason"</span><span class="mtk1">: </span><span class="mtk6">"사용자 요청"</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1">    }</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1">  ],</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"suggestions"</span><span class="mtk1">: [</span><span class="mtk6">"분석 시작해줘"</span><span class="mtk1">, </span><span class="mtk6">"장바구니 보여줘"</span><span class="mtk1">]</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1">}</span></div></div></div></div></div></div></pre>

### 15.5 STT API

| Method   | Path                | 설명           |
| -------- | ------------------- | -------------- |
| `POST` | `/stt/transcribe` | 음성 → 텍스트 |

 **Request** : `multipart/form-data`, `audio` 파일 (wav/m4a/mp3, 최대 30초)

**Response**

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">json</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">{</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"text"</span><span class="mtk1">: </span><span class="mtk6">"우유 2개 계란 한 판 신라면 5봉지"</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"confidence"</span><span class="mtk1">: </span><span class="mtk5">0.95</span><span class="mtk1">,</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1"></span><span class="mtk3">"duration_ms"</span><span class="mtk1">: </span><span class="mtk5">3200</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">}</span></div></div></div></div></div></div></pre>

### 15.6 선호 브랜드 API

| Method   | Path                                        | 설명             |
| -------- | ------------------------------------------- | ---------------- |
| `GET`  | `/preferences/brands/{canonical_item_id}` | 선호 브랜드 조회 |
| `POST` | `/preferences/brands`                     | 선호 브랜드 설정 |

### 15.7 유틸 API

| Method  | Path                            | 설명              |
| ------- | ------------------------------- | ----------------- |
| `GET` | `/utils/geocode?query={주소}` | 주소 → 좌표 변환 |

---

## 16. FastAPI 앱 초기화 (lifespan)

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk13">@asynccontextmanager</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk3">async</span><span class="mtk1"></span><span class="mtk3">def</span><span class="mtk1"></span><span class="mtk13">lifespan</span><span class="mtk1">(</span><span class="mtk5 mtki">app</span><span class="mtk1">: FastAPI):</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1"></span><span class="mtk3">await</span><span class="mtk1"></span><span class="mtk13">init_db</span><span class="mtk1">()</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">    db = </span><span class="mtk3">await</span><span class="mtk1"></span><span class="mtk13">get_app_db</span><span class="mtk1">()</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">    cache_db = </span><span class="mtk3">await</span><span class="mtk1"></span><span class="mtk13">get_cache_db</span><span class="mtk1">()</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">    cache = </span><span class="mtk13">CacheService</span><span class="mtk1">(cache_db)</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk1"></span><span class="mtk8"># API 키 유무에 따라 실제 / Mock Provider 자동 선택</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk1">    routing = </span><span class="mtk13">NaverRoutingProvider</span><span class="mtk1">(</span><span class="mtk5">...</span><span class="mtk1">) </span><span class="mtk3">if</span><span class="mtk1"> settings.ncp_client_id </span><span class="mtk3">else</span><span class="mtk1"></span><span class="mtk13">MockRoutingProvider</span><span class="mtk1">()</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk1">    weather = </span><span class="mtk13">KmaWeatherProvider</span><span class="mtk1">(</span><span class="mtk5">...</span><span class="mtk1">)   </span><span class="mtk3">if</span><span class="mtk1"> settings.kma_service_key </span><span class="mtk3">else</span><span class="mtk1"></span><span class="mtk13">MockWeatherProvider</span><span class="mtk1">()</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk1">    place   = </span><span class="mtk13">NaverLocalPlaceProvider</span><span class="mtk1">(</span><span class="mtk5">...</span><span class="mtk1">) </span><span class="mtk3">if</span><span class="mtk1"> settings.naver_client_id </span><span class="mtk3">else</span><span class="mtk1"></span><span class="mtk5">None</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk1"></span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk1">    app.state.plan_service = </span><span class="mtk13">PlanService</span><span class="mtk1">(</span><span class="mtk4 mtki">db</span><span class="mtk1">=db, </span><span class="mtk4 mtki">routing_provider</span><span class="mtk1">=routing, </span><span class="mtk5">...</span><span class="mtk1">)</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk1"></span><span class="mtk3">yield</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk1"></span><span class="mtk3">await</span><span class="mtk1"> db.</span><span class="mtk13">close</span><span class="mtk1">()</span></div></div><div class="code-line" data-line-number="16" data-line-start="16" data-line-end="16"><div class="line-content"><span class="mtk1"></span><span class="mtk3">await</span><span class="mtk1"> cache_db.</span><span class="mtk13">close</span><span class="mtk1">()</span></div></div></div></div></div></div></pre>

---

## 17. 보안 요구사항

### 17.1 민감 정보 처리

| 데이터    | 처리 방식                     |
| --------- | ----------------------------- |
| 주소      | 마스킹 저장                   |
| 결제 수단 | 끝 4자리만 표시               |
| 원본 음성 | 기본 미저장, opt-in 시 암호화 |
| 위치 정보 | 처리 후 삭제                  |

### 17.2 로그 정책 (최소 운영용)

 **저장** : 요청/응답 상태코드, 에러 로그, 플랜 생성 성공/실패, 예약 실행 이력
 **저장 금지** : 원본 음성, 결제 수단 원문, 개인 식별 가능 검색어

### 17.3 구매 가드레일

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all my-2 rounded-lg bg-list-hover-subtle border border-gray-500/20"><div class="min-h-7 relative box-border flex flex-row items-center justify-between rounded-t border-b border-gray-500/20 px-2 py-0.5"><div class="font-sans text-sm text-ide-text-color opacity-60">python</div><div class="flex flex-row gap-2 justify-end"><div class="cursor-pointer opacity-70 hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide lucide-copy h-3.5 w-3.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></div></div></div><div class="p-3"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk8"># 코드 레벨에서 강제</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1">require_approval: </span><span class="mtk16">bool</span><span class="mtk1"> = </span><span class="mtk5">True</span><span class="mtk1"></span><span class="mtk8"># 항상 True, 변경 불가</span></div></div></div></div></div></div></pre>

---

## 18. 성능 요구사항

| 항목                 | 목표                 |
| -------------------- | -------------------- |
| 플랜 생성 응답       | 5초 이내 (P95)       |
| STT 처리             | 3초 이내 (30초 음성) |
| API 응답 (캐시 히트) | 200ms 이내           |
| 동시 사용자          | 100명 (MVP)          |

* 온라인/오프라인 검색 **병렬 실행**
* 부분 실패 시 `206 Partial Content` 반환 + `degraded_providers` 목록 포함

---

## 19. 주의사항 요약 (레퍼런스 기반)

| 항목                                | 내용                                                                 |
| ----------------------------------- | -------------------------------------------------------------------- |
| `_to_grid()`                      | 기상청 LCC DFS 공식 —**절대 수정 금지**                       |
| `_parse_coordinates()`            | 네이버 좌표 포맷 2가지(WGS84 / 1e7) 모두 처리 필수                   |
| `row_factory`                     | `db.row_factory = aiosqlite.Row` 없으면 `dict(row)` 변환 불가    |
| 캐시 키 소수점                      | 장소 `:.3f`, 경로 `:.5f` — 정밀도 다름 (의도적)                 |
| `_log_call()`                     | 모든 Provider 공통 패턴 →`BaseProvider` 추상 클래스로 공통화 권장 |
| NaverLocal 좌표                     | 좌표 필터링 미지원 → Haversine으로 후처리 필수                      |
| `_chat_history`                   | 인메모리 → 서버 재시작 시 초기화 (DB 연동 시 해결)                  |
| `_basket` 전역변수                | 라우터 간 직접 import → DB 연동 시 해결                             |
| `_build_purchase_history_context` | 중복 정의 버그 → 통합 필요                                          |

---

## 20. Sprint별 구현 계획

### Sprint 1 (2주): 최소 루프

| 항목          | 구현                          |
| ------------- | ----------------------------- |
| STT           | Whisper medium                |
| BasketParser  | LLM (GPT-4o-mini)             |
| OnlineSearch  | 네이버쇼핑 Hybrid Search      |
| OfflineSearch | **MockOfflineProvider** |
| RankingEngine | CHEAPEST / NEAREST / BALANCED |
| ChatService   | LLM 챗봇 + diff 파싱          |
| DB            | SQLite + CacheService         |

 **DoD** : 5개 품목 입력 → Top3 플랜 화면 재현 가능

### Sprint 2 (2주): 오프라인 고도화

| 항목          | 구현                  |
| ------------- | --------------------- |
| OfflineSearch | 네이버 Local API 연동 |
| 이동시간      | 네이버 Directions API |
| 날씨          | 기상청 API 연동       |
| 예약          | Schedule API 구현     |
| DB            | PostgreSQL 전환 검토  |
